<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="initial-scale=1.0,user-scalable=no" />

  <title>地图聚合</title>
  <style type="text/css">
    body {width:100%;height: 100%; overflow:hidden;margin: 0px;padding: 0px;font-family: "微软雅黑 Light";}
    html{height: 100%}
    #allmap {height: 100%}
  </style>

  <!--  去除“百度地图”左下角字样  -->
  <style type="text/css">

    /*版权字样*/
    .BMap_cpyCtrl {
      display: none;
    }

    /*百度字样*/
    .anchorBL {
      display: none;
    }
  </style>
  <style type="text/css">
    .infoBoxContent{font-size:12px;}
    .infoBoxContent .title{background:url(/bdMap/img/title.jpg) no-repeat;height:42px;width:272px;}
    .infoBoxContent .title strong{font-size:14px;line-height:42px;padding:0 10px 0 5px;}
    .infoBoxContent .title .price{color:#FFFF00;}
    .infoBoxContent .list{width:268px;border:solid 1px #4FA5FC;border-top:none;background:#fff;height:260px;}
    .infoBoxContent .list ul{margin:0;padding:5px;list-style:none;}
    .infoBoxContent .list ul li {float:left;width:255px;border-bottom:solid 1px #4FA5FC;padding:2px 0;}
    .infoBoxContent .list ul .last{border:none;}
    .infoBoxContent .list ul img{width:53px;height:42px;margin-right:5px;}
    .infoBoxContent .list ul p{padding:0;margin:0;}
    .infoBoxContent .left{float:left;}
    .infoBoxContent .rmb{float:right;color:#EB6100;font-size:14px;font-weight:bold;}
    .infoBoxContent a{color:#0041D9;text-decoration:none;}
  </style>
  <link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css" />
  <link rel="stylesheet" href="http://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.css"/>
  <link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css"/>
  <link rel="stylesheet" href="http://api.map.baidu.com/library/TrafficControl/1.4/src/TrafficControl_min.css"/>

  <script type="text/javascript" src="http://api.map.baidu.com/api?v=3.0&ak=Zyq6TjFQ1679hxUWSUhud4i03GThAEGI"></script>
  <script type="text/javascript" src="http://api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js"></script>
  <script type="text/javascript" src="http://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js"></script>
  <script type="text/javascript" src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
  <script type="text/javascript" src="http://api.map.baidu.com/library/TrafficControl/1.4/src/TrafficControl_min.js"></script>

  <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script type="text/javascript" src="/bdMap/js/BMapLib/RichMarker.min.js"></script>
  <script type="text/javascript" src="/bdMap/js/BMapLib/InfoBox.min.js"></script>
<!--  此Key为测试用，可能随时会被删除，请替换为自己的key。-->
</head>
<body>

<div id="results" style="width:400px;height: 500px;position: absolute;margin-top: 230px;margin-left:5px;z-index: 100; background-color: #4FA5FC">

</div>

<div style="width: 200px;height: 100px;position: absolute;margin-top: 930px;margin-left:5px;z-index: 100;">
  <input style="width: 80px;height: 30px;padding-left: 10px; background-color: royalblue;color: antiquewhite; border-radius: 2px;" type="button" value="青花瓷" onclick="setMapStyleFromId()">
  <input style="width: 80px;height: 30px;padding-left: 10px; background-color: #69b0ac;color: antiquewhite;" type="button" value="葱油绿" onclick="setMapStyleFromJson()">
</div>

<div style="width: 200px;height: 100px;position: absolute;margin-top: 930px;margin-left:175px;z-index: 101;">
  <input style="width: 80px;height: 30px;padding-left: 10px; background-color: steelblue;color: antiquewhite;" type="button" value="添加标注" onclick="addMapMarker()">
  <input style="width: 80px;height: 30px;padding-left: 10px; background-color: steelblue;color: antiquewhite;" type="button" value="删除标注" onclick="removeMapMarker()">
</div>

<div style="width: 200px;height: 100px;position: absolute;margin-top: 930px;margin-left:345px;z-index: 101;">
  <input style="width: 80px;height: 30px;padding-left: 5px; background-color: steelblue;color: antiquewhite;" type="button" value="添加富标注" onclick="addRichMarker()">
  <input style="width: 80px;height: 30px;padding-left: 5px; background-color: steelblue;color: antiquewhite;" type="button" value="删除富标注" onclick="removeRichMarker()">
</div>
<div style="width: 300px;height: 100px;position: absolute;margin-top: 930px;margin-left:520px;z-index: 101;">
  <input style="width: 80px;height: 30px;padding-left: 5px; background-color: steelblue;color: antiquewhite;" type="button" value="设置点聚合" onclick="setCluster()">
  <input style="width: 80px;height: 30px;padding-left: 5px; background-color: steelblue;color: antiquewhite;" type="button" value="改变样式" onclick="changStyles()">
  <input style="width: 80px;height: 30px;padding-left: 5px; background-color: steelblue;color: antiquewhite;" type="button" value="删除点聚合" onclick="withoutCluster()">
</div>

<div style="width: 200px;height: 100px;position: absolute;margin-top: 930px;margin-left:900px;z-index: 101;">
  <input style="width: 80px;height: 30px;padding-left: 5px; background-color: steelblue;color: antiquewhite;" type="button" value="矢量图层" onclick="addCanvasLayer()">
  <input style="width: 80px;height: 30px;padding-left: 5px; background-color: steelblue;color: antiquewhite;" type="button" value="删除图层" onclick="removeCanvasLayer()">
</div>
<div style="width: 300px;height: 100px;position: absolute;margin-top: 930px;margin-left:1080px;z-index: 101;">
  <input style="width: 80px;height: 30px;padding-left: 5px; background-color: steelblue;color: antiquewhite;" type="button" value="兴趣点搜索" onclick="poiSearch()">
  <input style="width: 80px;height: 30px;padding-left: 5px; background-color: steelblue;color: antiquewhite;" type="button" value="附近搜索" onclick="nearbySearch()">
  <input style="width: 80px;height: 30px;padding-left: 5px; background-color: steelblue;color: antiquewhite;" type="button" value="范围搜索" onclick="inBoundSearch()">
</div>
  <div id="allmap"> </div>

</body>
</html>
<script type="text/javascript">

  var map = null;
  var point = new BMap.Point(117.2972, 31.8988);

  setMap();

  /**
   * 加载地图事件
   **/
  function setMap(){
    initialMap();
    addMapControls();
    addDrawManager();
  }
  /**
   * 初始化地图
   **/
  function initialMap() {
    map = new BMap.Map("allmap", {
      coordsType: 5,//coordsType 指定输入输出的坐标类型，3 为  gcj02坐标，5为bd011坐标，默认为5，
                    //指定完成后，API将以指定的坐标类型处理您传入的坐标
      enableBizAuthLogo: false
    });

    map.centerAndZoom(point, 15);// 初始化地图，中心点和缩放级别
    map.enableScrollWheelZoom(true);
  }

  /**
   *  添加地图导航控件
   **/
  function addMapControls() {
    map.addControl(new BMap.NavigationControl());
    //添加地图比例尺控件

    /**
     * 比例尺工具与版本标识工具所用同一个class，anchorBL, 所以，当采用CSS方式 display:none 去掉左下角
     * 的百度标识和版权标识时，缩放比例工具也会被隐藏。
     **/
    var opts = {offset: new BMap.Size(150, 5)}
    map.addControl(new BMap.ScaleControl(opts));

    map.addControl(new BMap.OverviewMapControl());

    /**
     * 此种方法添加为三种类型，地图/卫星/三维，其中切换至三维时无法显示地图，也无官方文档所说的切换城市
     * 不建议采用此种方法
     */
    // map.addControl(new BMap.MapTypeControl());
    // map.setCurrentCity("合肥");

    //添加地图控件, 矢量图和卫星图。 矢量图为卫星地图+矢量标注
    map.addControl(new BMap.MapTypeControl({
      mapTypes: [
        BMAP_NORMAL_MAP, //矢量图
        //BMAP_SATELLITE_MAP,  //卫星图， 此选项不起作用
        BMAP_HYBRID_MAP //混合图， 卫星+矢量图中的街道和标注
      ]
    }));

    addTrafficControl();//添加交通流量图
  }

  /**
   * 使用样式ID设置地图样式
   */
  function setMapStyleFromId(){
      map.setMapStyleV2({
          styleId:'f1d776a2b7da27c7455843c309a9fac3'
      });
  }

  /**
   * 使用样式Json文件设置地图样式
   */
  function setMapStyleFromJson() {

    $.getJSON('/bdMap/data/custom_map_config.json', function (json) {
      map.setMapStyleV2({
        styleJson: json
      });
    });
  }

  function addMapMarker(){
    addMarkerPoint();
    addMarkerPolyline();
    addMarkerIcon();
    addMarkerPolygon();
  }

  function removeMapMarker(){
    map.clearOverlays();
  }

  /**
   * 添加点标注
   **/
  function addMarkerPoint() {

    var marker = new BMap.Marker(point);
    map.addOverlay(marker);

    marker.addEventListener("click", function () {

      var htmlContent = ["<div class='infoBoxContent'><div class='title'><strong>中海雅园</strong><span class='price'>均价43000，overlay-下面的链接无法打开，而infobox可以</span></div>",
        "<div class='list'><ul><li><div class='left'><img src='/bdMap/img/house3.jpg'/></div><div class='left'><a target='_blank' href='http://map.baidu.com'>中海雅园南北通透四居室</a><p>4室2厅，205.00平米，3层</p></div><div class='rmb'>760万</div></li>"
        ,"<li><div class='left'><img src='/bdMap/img/house1.jpg'/></div><div class='left'><a target='_blank' href='http://map.baidu.com'>中海雅园四居室还带保姆间</a><p>2室1厅，112.00平米，16层</p></div><div class='rmb'>300万</div></li>"
        ,"<li><div class='left'><img src='/bdMap/img/house2.jpg'/></div><div class='left'><a target='_blank' href='http://map.baidu.com'>《有钥匙 随时看》花园水系</a><p>3室2厅，241.00平米，16层</p></div><div class='rmb'>400万</div></li>"
        ,"<li><div class='left'><img src='/bdMap/img/house3.jpg'/></div><div class='left'><a target='_blank' href='http://map.baidu.com'>富力城D区正规楼王大三居</a><p>3室3厅，241.00平米，17层</p></div><div class='rmb'>600万</div></li>"
        ,"<li class='last'><div class='left'><img src='/bdMap/img/house1.jpg'/></div><div class='left'><a target='_blank' href='http://map.baidu.com'>富力城豪，身份人士的象征</a><p>4室2厅，213.90平米，25层</p></div><div class='rmb'>700万</div></li>"
        ,"</ul></div>"
        ,"</div>"];

      var richContent = new BMapLib.RichMarker(htmlContent.join(""),point,{

        "anchor": new BMap.Size(-72,-86),
        "enableDragging":true
      });
      map.addOverlay(richContent);

    });
    marker.enableDragging();
    marker.addEventListener("dragend", function(e){
      alert("当前位置：" + e.point.lng + ", " + e.point.lat);
    });
  }

  /**
   *添加线标注
   **/
  function addMarkerPolyline(){
    var polyline = new BMap.Polyline([
      new BMap.Point(117.2972,31.8988),
      new BMap.Point(117.2872,31.9088)
    ],
      {
        strokeColor:"blue",
        strokeWeight:6,
        strokeOpacity:0.5
      });
    map.addOverlay(polyline);

    polyline.addEventListener("click",function () {
      var linePaths = polyline.getPath();
      var centerx = (linePaths[0].lng + linePaths[linePaths.length -1].lng)/2;
      var centery = (linePaths[0].lat + linePaths[linePaths.length -1].lat)/2;
      var center = new BMap.Point(centerx,centery)
      addSimpleInfo(center,"你点了这条线。")
    })
  }

  /**
   * 添加自定义标注
   */
  function addMarkerPolygon(){

    var circle = new BMap.Circle(point,500,{
      strokeColor:"green",
      strokeWeight:2,
      strokeOpacity:0.7
    });

    circle.addEventListener("click",function () {
      var center = circle.getBounds().getCenter();
      addSimpleInfo(center,"你点了这个圆。");
    });
    map.addOverlay(circle);

    var pEnd = new BMap.Point(117.3172,31.9188);
    var rectangle = new BMap.Polygon([
      new BMap.Point(point.lng,point.lat),
      new BMap.Point(pEnd.lng,point.lat),
      new BMap.Point(pEnd.lng,pEnd.lat),
      new BMap.Point(point.lng,pEnd.lat)
    ],{
      strokeColor:'yellow',
      strokeWeight:2,
      strokeOpacity:0.5
    });
    rectangle.addEventListener("click",function () {
      var center = rectangle.getBounds().getCenter();
      addSimpleInfo(center,"你点了这个长方形。");
    });
    map.addOverlay(rectangle);

    var polygon = new BMap.Polygon([
      new BMap.Point(117.2972,31.8988),
      new BMap.Point(117.2625,31.8635),
      new BMap.Point(117.3223,31.8534),
      new BMap.Point(117.3568,31.85863),
      new BMap.Point(117.3465,31.88641)
    ],{
      strokeColor:"red",
      strokeWeight: 3,
      strokeOpacity: 0.6
    });
    polygon.addEventListener("click",function (){
      var center = polygon.getBounds().getCenter();
      addSimpleInfo(center,"你点了个多边形。")
    })
    map.addOverlay(polygon);

    map.addOverlay(new BMapLib.TextIconOverlay(new BMap.Point(117.2972,31.8988), 7));
    map.addOverlay(new BMapLib.TextIconOverlay(new BMap.Point(117.2625,31.8635), 15));
    map.addOverlay(new BMapLib.TextIconOverlay(new BMap.Point(117.3223,31.8534), 24));
    map.addOverlay(new BMapLib.TextIconOverlay(new BMap.Point(117.3568,31.85863), 48));
    map.addOverlay(new BMapLib.TextIconOverlay(new BMap.Point(117.3465,31.88641), 99));
  }

  /**
   * 添加自定义图标标注
   **/
  function addMarkerIcon(){
    var myIcon = new BMap.Icon("/bdMap/img/1.gif",new BMap.Size(36,36));
    var pt =new BMap.Point(117.3172,31.9188);
    var marker = new BMap.Marker(pt,{
      icon: myIcon
    });
    marker.enableDragging();
    map.addOverlay(marker);

    var opts = {
      position: pt,
      offset: new BMap.Size(10,10)
    }
    var label = new BMap.Label("这是一个测试用的站点",opts);

    marker.addEventListener("onmouseout", function(e) {
      map.removeOverlay(label);
    });
    marker.addEventListener("onmouseover", function(e) {
      console.log("泵房站点: " + e.point.lng + " , " + e.point.lat + " ; " + e.pixel.x + " , " + e.pixel.y + " | ");
      map.addOverlay(label);
    });

    addMarkerInfo(marker);
  }


  var myRM;
  var myRichMarker1;
  var myRichMarker2;

  /**
   * 添加富标注
   */
  function addRichMarker(){

    addNormalRich();
    addBestRich();

    /**
     * 添加图片富标注
     **/
    function addNormalRich(){

      var htmlContent = "<div style='background:#E7F0F5;color:#0082CB;border:1px solid #333;width:300px;'>"
        +     "欢迎光临舜禹水务！"
        +     "<img src='http://shunyuwater.com/data/img/logo12.png' height='100px' width='300px' border='0' />"
        + "</div>";

      myRm = new BMapLib.RichMarker(htmlContent,point,{
        "anchor": new BMap.Size(-72,-86),
        "enableDragging":true});
      map.addOverlay(myRm);

      myRm.addEventListener("onmousedown", function(e) {
        console.log("MouseDown : " + e.point.lng + " , " + e.point.lat + " ; " + e.pixel.x + " , " + e.pixel.y + " | ");
      });
      myRm.addEventListener("onclick", function(e) {
        console.log("Click | ");
      });
      myRm.addEventListener("onmouseup", function(e) {
        console.log("MouseUp : " + e.point.lng + " , " + e.point.lat + " ; " + e.pixel.x + " , " + e.pixel.y + " | ");
      });
      myRm.addEventListener("onmouseout", function(e) {
        console.log("MouseOut : " + e.point.lng + " , " + e.point.lat + " ; " + e.pixel.x + " , " + e.pixel.y + " | ");
      });
      myRm.addEventListener("onmouseover", function(e) {
        console.log("MouseOver : " + e.point.lng + " , " + e.point.lat + " ; " + e.pixel.x + " , " + e.pixel.y + " | ");
      });
      myRm.addEventListener("ondragstart", function(e) {
        console.log("DragStart | ");
      });
      myRm.addEventListener("ondragging", function(e) {
        console.log("Dragging : " + e.point.lng + " , " + e.point.lat + " ; " + e.pixel.x + " , " + e.pixel.y + " | ");
      });
      myRm.addEventListener("ondragend", function(e) {
        console.log("DragEnd : " + e.point.lng + " , " + e.point.lat + " ; " + e.pixel.x + " , " + e.pixel.y + " | ");
      });
      myRm.addEventListener("onremove", function(e) {
        console.log("remove |");
      });

      myRm.addEventListener("ondblclick", function(e) {
        console.log("RM dblclick |");
      });

      myRm.addEventListener("onclick", function(e) {
        console.log("RM click |");

      });
      myRm.addEventListener("ontouchend", function(e) {
        console.log("touchend |");
      });

      myRm.addEventListener("click", function(e) {
        alert("你可以拖着我移动哦。❥(^_-)")
      });
    }

    /**
     * 添加复杂富标注
     **/
    function addBestRich(){

      var htm1 = "<div id='overLay' style='width:93px;height:116px;background:url(/bdMap/img/back.png) left top no-repeat; position: absolute;'>"
        +      "<img style='margin-left:9px;margin-top: 8px;' src='/bdMap/img/small.jpg' />"
        + "</div>";

      myRichMarker1 = new BMapLib.RichMarker(htm1,  new BMap.Point(117.2972, 31.9188),{
          "anchor" : new BMap.Size(-47, -116),
          "enableDragging" : true});
      map.addOverlay(myRichMarker1);
      myRichMarker1.addEventListener("click", function(e) {
        alert("你可以拖着我移动哦。❥(^_-)")
      });

      var html2 = '<div style="position: absolute; margin: 0pt; padding: 0pt; width: 80px; height: 26px; left: -10px; top: -35px; overflow: hidden;">'
        +     '<img id="rm3_image" style="border:none;left:0px; top:0px; position:absolute;" src="/bdMap/img/back1.png">'
        + '</div>'
        + '<label class=" BMapLabel" unselectable="on" style="position: absolute; -moz-user-select: none; display: inline; cursor: inherit; border: 0px none; padding: 2px 1px 1px; white-space: nowrap; font: 12px arial,simsun; z-index: 80; color: rgb(255, 102, 0); left: 15px; top: -35px;">$ 20 B</label>';

      myRichMarker2 = new BMapLib.RichMarker(html2,  new BMap.Point(117.2872, 31.9088),{
          "anchor" : new BMap.Size(-18, -27),
          "enableDragging" : true});
      map.addOverlay(myRichMarker2);

      myRichMarker2.addEventListener("click", function(e) {
        alert("你可以拖着我移动哦。❥(^_-)")
      });
      myRichMarker2.addEventListener("onmouseover", function(e) {
        document.getElementById("rm3_image").src = "/bdMap/img/back2.png";
      });
      myRichMarker2.addEventListener("onmouseout", function(e) {
        document.getElementById("rm3_image").src = "/bdMap/img/back1.png";
      });
    }
  }

  /**
   * 删除富标注
   */
  function removeRichMarker(){
    if(myRm)
    map.removeOverlay(myRm);

    if(myRichMarker1){
      map.removeOverlay(myRichMarker1);
    }

    if(myRichMarker2){
      map.removeOverlay(myRichMarker2);
    }
  };


  /**
   * 添加简单信息框
   */
  function addSimpleInfo(point,content){
    var opts = {
      width:250,
      height:100,
      title:"<div class='title' style='color: #4FA5FC'><strong>信息窗口</strong></div>"
    };
    var infoWindow = new BMap.InfoWindow(content,opts);
    map.openInfoWindow(infoWindow,point);
    //
    // marker.addEventListener("onclick",function (e) {
    //   infoWindow.open(marker);
    // });
  }

  /**
   * 添加复杂信息框，使用InfoBox时，html中的链接可以打开，而使用Overlay时，链接不可以。
   * 应该Overlay虽然有链接，但应该整个作为一个marker来处理，不能对其内部进行操作。
   * @param marker
   */
  function addMarkerInfo(marker){

    var html = ["<div class='infoBoxContent'><div class='title'><strong>中海雅园</strong><span class='price'>均价43000</span></div>",
      "<div class='list'><ul><li><div class='left'><img src='/bdMap/img/house3.jpg'/></div><div class='left'><a target='_blank' href='http://map.baidu.com'>中海雅园南北通透四居室</a><p>4室2厅，205.00平米，3层</p></div><div class='rmb'>760万</div></li>"
      ,"<li><div class='left'><img src='/bdMap/img/house1.jpg'/></div><div class='left'><a target='_blank' href='http://map.baidu.com'>中海雅园四居室还带保姆间</a><p>2室1厅，112.00平米，16层</p></div><div class='rmb'>300万</div></li>"
      ,"<li><div class='left'><img src='/bdMap/img/house2.jpg'/></div><div class='left'><a target='_blank' href='http://map.baidu.com'>《有钥匙 随时看》花园水系</a><p>3室2厅，241.00平米，16层</p></div><div class='rmb'>400万</div></li>"
      ,"<li><div class='left'><img src='/bdMap/img/house3.jpg'/></div><div class='left'><a target='_blank' href='http://map.baidu.com'>富力城D区正规楼王大三居</a><p>3室3厅，241.00平米，17层</p></div><div class='rmb'>600万</div></li>"
      ,"<li class='last'><div class='left'><img src='/bdMap/img/house1.jpg'/></div><div class='left'><a target='_blank' href='http://map.baidu.com'>富力城豪，身份人士的象征</a><p>4室2厅，213.90平米，25层</p></div><div class='rmb'>700万</div></li>"
      ,"</ul></div>"
      ,"</div>"];

    var infoBox = new BMapLib.InfoBox(map,html.join(""),{
      boxStyle:{
        background:"url('/bdMap/img/tipbox.gif') no-repeat center top"
        ,width: "270px"
        ,height: "300px"
      }
      ,offset: new BMap.Size(10,20)
      ,closeIconUrl:"/bdMap/img/close.png"
      ,closeIconMargin: "1px 1px 0 0"
      ,enableAutoPan: true
      ,align: INFOBOX_AT_TOP
    });

    marker.addEventListener("onclick", function(e) {
      infoBox.open(marker);
    });
  }

  var markerCluster = null;

  var i =1;

  var defaultStyles;

  var myStyles = [{
    url: '/bdMap/img/cluster/m1.png',
    size: new BMap.Size(53, 52),
    //opt_anchor: [16, 0],
    textColor: '#f5f1f6',
    opt_textSize: 10
  }, {
    url: '/bdMap/img/cluster/m2.png',
    size: new BMap.Size(56, 55),
    //opt_anchor: [40, 35],
    textColor: '#ebecf1',
    opt_textSize: 12
  }, {
    url: '/bdMap/img/cluster/m3.png',
    size: new BMap.Size(78, 77),
    //opt_anchor: [32, 0],
    textColor: '#e5e6ec',
    opt_textSize: 14
  }];

  /**
   * 点的聚合
   */
  function setCluster(){

    var MAX = 100 * 1;
    var markers = [];
    var pt = null;
    var i=0;
    for(;i < MAX; i++){
      pt = new BMap.Point(Math.random() * 40 + 85, Math.random() * 30 + 21);
      markers.push(new BMap.Marker(pt));
    }

    if(markerCluster){
      markerCluster.addMarkers(markers);
    } else {
      markerCluster = new BMapLib.MarkerClusterer(map,{markers:markers}); //请记住是 MarkerClusterer
    }

    if(!defaultStyles)
    {
      defaultStyles = markerCluster.getStyles();
    }
  }

  var styleType =0;
  function changStyles(){
    if(styleType == 0){
      markerCluster.setStyles(myStyles);
      styleType = 1;
    } else if(styleType == 1){
      markerCluster.setStyles(defaultStyles);
      styleType = 0;
    }
  }

  /**
   * 取消点聚合
   */
  function withoutCluster(){
    if(markerCluster)
      markerCluster.clearMarkers();

    var MAX = 100;
    var pt = null;
    var i=0;
    for(;i < MAX; i++){
      pt = new BMap.Point(Math.random() * 40 + 85, Math.random() * 30 + 21);
      var marker = new BMap.Marker(pt);
      map.addOverlay(marker);
    }
  }


  function addTrafficControl(){
    var ctrl = new BMapLib.TrafficControl({
      showPanel: false //是否显示路况提示面板
    });
    map.addControl(ctrl);
    ctrl.setAnchor(BMAP_ANCHOR_BOTTOM_RIGHT);
  }

  var trafficLayer = null;//交通流量图层
  var trafficType = 0 ;
  /**
   * 添加交通流量图层
   */
  function showTrafficLayer(){

    if(trafficType == 0){
      addTrafficeLayer();
      trafficType = 1;
    } else {
      removeTrafficLayer();
      trafficType = 0 ;
    }
  }

  function addTrafficeLayer(){
    trafficLayer = new BMap.TrafficLayer();
    map.addTileLayer(trafficLayer);
  }

  function removeTrafficLayer(){
    if(trafficLayer){
      map.removeTileLayer(trafficLayer);
    }
  }

  // 添加地图绘制功能
  var overlays = [];
  var overlaycomplete = function(e){
    overlays.push(e.overlay);
  }

  function clearAll(){
    for(var i=0;i< overlays.length;i++){
      map.removeOverlay(overlay);
    }
    overlays.length =0;
  }

  function addDrawManager(){
    var styleOptions = {
      storkColor:"red",
      fillColor:"red",
      strokeWeight:3,
      strokeOpacity:0.7,
      fillOpacity: 0.6,
      strokeStyle:'solid'
    }

    var drawingManager = new BMapLib.DrawingManager(map,{
      _isOpen:false,
      enableDrawingTool:true,
      drawingToolOptions:{
        anchor: BMAP_ANCHOR_TOP_RIGHT,
        offset: new BMap.Size(5,5)
      },
      circleOptions:styleOptions,
      polylineOptions:styleOptions,
      polygonOptions: styleOptions,
      rectangleOptions: styleOptions
    });
    drawingManager.addEventListener('overlaycomplete',overlaycomplete);

  }

  // 添加Canvas2D覆盖物
  var canvasLayer = null;

  function addCanvasLayer(){

    /**
     * 如果已存在，则删除，否则添加多个后，无法通过 removeCanvasLayer 函数删除，
     **/
    if(canvasLayer){
      removeCanvasLayer();
      canvasLayer = null;
    }

    canvasLayer = new BMap.CanvasLayer({
      update:update
    });

    function update(){
      var ctx = this.canvas.getContext("2d");
      if(!ctx){
        return;
      }

      ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
      var temp = {};
      ctx.fillStyle = "rgba(50,50,255,0.7)";
      ctx.beginPath();
      var data = [
        new BMap.Point(117.3223,31.8534),
        new BMap.Point(117.3568,31.85863),
        new BMap.Point(117.3465,31.88641)
      ];
      for(var i=0,len = data.length; i<len;i++) {
        var pixel = map.pointToPixel(data[i]);
        ctx.fillRect(pixel.x,pixel.y,30,30);
      }
    }
    map.addOverlay(canvasLayer);
  }

  //移除canvasLayer
  function removeCanvasLayer(){
    if(canvasLayer){
      map.removeOverlay(canvasLayer);
    }
  }

  /**
   * 添加地图事件
   */
  function addMapEvents() {

    map.addEventListener("zoomend",function () {
      console.log("地图缩放至" + this.getZoom()+"级");
    })

    function showinfo(e){
      console.log(e.point.lng + "," + e.point.lat);
      map.removeEventListener("click",showinfo);
    }

    map.addEventListener("click",showinfo);
  }

  var local = null; //公共变量 查询对象
  var rendOpts = {
    map:map,
    autoViewport:true,
    panel:"results",
    selectFirstResult:false
  };

  var searchOpts = {
    renderOptions: rendOpts,
    pageCapacity:6
  };

  function clearSearch(){
    if(local){
      local.clearResults();
    }
  }
  /**
   * POI搜索
   */
  function poiSearch(){
    clearSearch();
    local = new BMap.LocalSearch(map,searchOpts);
    local.search("公园");
  };

  function nearbySearch(){
    clearSearch();
    local = new BMap.LocalSearch(map,searchOpts);
    local.searchNearby("酒店","三里庵");
  }

  function inBoundSearch(){
    clearSearch();
    local = new BMap.LocalSearch(map,searchOpts);
    local.searchInBounds("银行",map.getBounds());
  }


</script>
